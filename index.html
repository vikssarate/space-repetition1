<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Flash Cards â€” Date-wise + IDB media + Edit</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<style>
:root{--bg:#0f1220;--card:#181c2f;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f;--bad:#ff7575}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;-webkit-tap-highlight-color:transparent}
header,footer{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.wrap{max-width:900px;margin:0 auto;padding:8px 16px 80px}
.btn{appearance:none;border:1px solid var(--accent);background:transparent;color:var(--ink);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.btn:active{transform:scale(.98)}
.badge{display:inline-flex;gap:6px;align-items:center;padding:3px 10px;border:1px solid var(--line);border-radius:9999px;color:var(--muted);font-size:12px}

/* Start */
#startScreen{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:5;border-top:6px solid var(--accent);border-bottom:6px solid var(--accent)}
.start-btn{user-select:none;cursor:pointer;min-width:220px;padding:18px 28px;border:3px solid var(--accent);border-radius:9999px;font-weight:700;font-size:22px;background:transparent;color:var(--ink);box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 9999px rgba(108,168,255,.06)}
#loading{margin-top:10px;color:#9aa3c7;display:none}
#err{margin-top:10px;color:var(--bad);font-weight:600;font-size:14px;text-align:center;max-width:90%}

/* Timeline + cards */
.timeline{position:relative;margin:8px auto}
.timeline:before{content:"";position:absolute;left:calc(50% - 2px);top:0;bottom:0;width:4px;background:var(--line);border-radius:2px;opacity:.8}
.card{position:relative;display:flex;justify-content:center;align-items:center;width:min(92%,560px);margin:34px auto 32px;padding:0;border:none;background:transparent;perspective:1000px}
.card::after{content:"";position:absolute;left:50%;bottom:-28px;transform:translateX(-50%);width:2px;height:28px;background:var(--line)}
.card:last-child::after{display:none}
.pill{position:relative;width:100%;min-height:110px;border-radius:9999px;border:3px solid var(--accent);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 9999px rgba(108,168,255,.05);transform-style:preserve-3d;transition:transform .45s cubic-bezier(.2,.7,.2,1)}
.card.flipped .pill{transform:rotateY(180deg)}
.side{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:14px 22px;text-align:center;font-size:22px;font-weight:700;backface-visibility:hidden;border-radius:9999px}
.side.back{transform:rotateY(180deg)}
.side .hint{font-weight:600;font-size:12px;color:var(--muted)}
.dateChip{position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:var(--bg);color:var(--ok);border:2px solid var(--ok);font-weight:700;font-size:12px;padding:2px 10px;border-radius:9999px;white-space:nowrap}
.btnRow{position:absolute;top:-26px;right:-2px;display:flex;gap:6px}
.cardBtn{border:1px solid var(--line);background:var(--card);border-radius:999px;padding:4px 8px;font-size:12px;cursor:pointer;color:#ddd}
.cardBtn:hover{border-color:#9aa3c7}
.cardBtn.del{color:#ffd1d1}
.cardBtn.del:hover{border-color:#ff8a8a;color:#fff;background:#7a1d1d}
#sentinel{height:1px}

/* Media */
.mediaBox{width:100%;max-width:460px}
.mediaImg{display:block;margin:0 auto;border-radius:14px;border:2px solid var(--line);max-height:220px;width:auto;max-width:100%;object-fit:cover;background:#0b1224}
.mediaNote{font:600 12px/1.2 system-ui;color:var(--muted);margin-top:4px}
.audioWrap{width:100%;max-width:460px}
audio{width:100%;outline:none;border-radius:10px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10;padding:20px}
.modalCard{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:780px;width:100%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
.modal h2{margin:0 0 8px 0;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid>label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
input[type="text"],textarea{background:#0c1328;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font:inherit}
textarea{min-height:70px;resize:vertical}
.row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--line);margin:8px 0}

/* chips (existing media) */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:flex;align-items:center;gap:6px;background:#0b1328;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font:600 12px/1 system-ui;color:#cfd7ff}
.chip b{font-weight:700}
.chip button{border:none;background:transparent;color:#ff9a9a;cursor:pointer;font-weight:800}
</style>
</head>
<body>
<header>
  <h1>Flash Cards â€” Date-wise</h1>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <button id="addBtn" class="btn">ï¼‹ Add</button>
    <button id="exportBtn" class="btn">Export JSON</button>
    <label class="btn" style="cursor:pointer">Import JSON
      <input id="importInp" type="file" accept=".json,application/json" hidden>
    </label>
    <span class="badge">Tap: Date â†’ Event â†’ Details â†’ Place â†’ Image â†’ Audio</span>
  </div>
</header>

<div class="wrap">
  <div id="timeline" class="timeline"></div>
  <div id="sentinel"></div>
</div>

<footer><div class="badge">Media in IndexedDB. Edits & deletes persist locally.</div></footer>

<!-- START -->
<div id="startScreen">
  <div style="text-align:center">
    <button id="startBtn" class="start-btn">Start</button>
    <div id="loading">Loading cards.jsonâ€¦</div>
    <div id="err"></div>
  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="modalCard">
    <h2 id="modalTitle">Add card</h2>
    <div class="grid">
      <label>Date (dd-mm-yyyy)
        <input id="fDate" type="text" placeholder="e.g., 26-01-1950" inputmode="numeric">
      </label>
      <label>Place
        <input id="fPlace" type="text" placeholder="City / Country">
      </label>
      <label style="grid-column:1/-1">Event / Title
        <input id="fEvent" type="text" placeholder="What happened?">
      </label>
      <label style="grid-column:1/-1">Details / Notes
        <textarea id="fDetails" placeholder="1â€“3 lines of context"></textarea>
      </label>

      <label>Image URLs (comma-separated)
        <input id="fImgUrls" type="text" placeholder="images/a.jpg, https://â€¦">
      </label>
      <label>Audio URLs (comma-separated)
        <input id="fAudUrls" type="text" placeholder="audio/a.mp3, https://â€¦">
      </label>

      <label>Attach Images (optional)
        <input id="fImgFiles" type="file" accept="image/*" multiple>
        <span class="small">Stored in IndexedDB (compressed jpg for size).</span>
      </label>
      <label>Attach Audio (optional)
        <input id="fAudFiles" type="file" accept="audio/*" multiple>
        <span class="small">Use .mp3/.m4a for iPad.</span>
      </label>

      <!-- Existing media (edit mode) -->
      <div style="grid-column:1/-1">
        <div class="small">Existing Images (tap Ã— to remove)</div>
        <div id="chipsImg" class="chips"></div>
      </div>
      <div style="grid-column:1/-1">
        <div class="small">Existing Audio (tap Ã— to remove)</div>
        <div id="chipsAud" class="chips"></div>
      </div>
    </div>

    <hr>
    <div id="modalErr" class="small" style="color:var(--bad)"></div>
    <div class="row">
      <button id="cancelBtn" class="btn">Cancel</button>
      <button id="saveBtn" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
/* ========= SETTINGS ========= */
const JSON_URL = 'cards.json';
const CHUNK = 12;
const statesBase = ['date','event','details','place'];
const LSK  = 'flashcards_datewise_user_v1';
const LSKD = 'flashcards_datewise_deleted_v1';

/* ========= ELEMENTS ========= */
const startBtn=document.getElementById('startBtn'), startScreen=document.getElementById('startScreen');
const loadingEl=document.getElementById('loading'), errEl=document.getElementById('err');
const timeline=document.getElementById('timeline'), sentinel=document.getElementById('sentinel');
const addBtn=document.getElementById('addBtn'), exportBtn=document.getElementById('exportBtn'), importInp=document.getElementById('importInp');
const modal=document.getElementById('modal'), modalTitle=document.getElementById('modalTitle'), modalErr=document.getElementById('modalErr');
const fDate=document.getElementById('fDate'), fPlace=document.getElementById('fPlace');
const fEvent=document.getElementById('fEvent'), fDetails=document.getElementById('fDetails');
const fImgUrls=document.getElementById('fImgUrls'), fAudUrls=document.getElementById('fAudUrls');
const fImgFiles=document.getElementById('fImgFiles'), fAudFiles=document.getElementById('fAudFiles');
const chipsImg=document.getElementById('chipsImg'), chipsAud=document.getElementById('chipsAud');
const cancelBtn=document.getElementById('cancelBtn'), saveBtn=document.getElementById('saveBtn');

/* ========= DATA ========= */
let master=[], pool=[], io=null;
const delSet = new Set(JSON.parse(localStorage.getItem(LSKD)||'[]'));
const cardSeq = new WeakMap(); // per-card tap sequence

/* modal state */
let editMode=false, editingObj=null;
let editImgs=[], editAuds=[];

/* ========= IndexedDB (media) ========= */
const DB_NAME='flashcards_media_db', DB_VER=1, STORE='media';
function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE)){ db.createObjectStore(STORE,{keyPath:'id'}); } };
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error||new Error('IndexedDB open failed'));
  });
}
async function idbPutBlob(type, blob){
  const db = await openDB();
  const id = `${type}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
  await new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
    tx.objectStore(STORE).put({id,type,mime:blob.type||'',created:Date.now(),blob});
  });
  db.close(); return id;
}
async function idbGetBlob(id){
  const db = await openDB();
  const val = await new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readonly'); tx.onerror=()=>rej(tx.error);
    const r=tx.objectStore(STORE).get(id); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
  });
  db.close(); if(!val) throw new Error('Not found'); return val.blob;
}
async function idbDelete(id){
  const db = await openDB();
  await new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
    tx.objectStore(STORE).delete(id);
  });
  db.close();
}
async function idbToDataURL(id){
  const blob = await idbGetBlob(id);
  return await new Promise((res)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); });
}

/* ========= Helpers ========= */
const pad=n=>(n<10?'0':'')+n;
const esc=s=>String(s==null?'':s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const toArr=v=>v==null?[]:(Array.isArray(v)?v:[v]);
const el=(t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;};
const splitUrls=str=>!str?[]:str.split(',').map(s=>s.trim()).filter(Boolean);
function parseDDMMYYYY(s){
  if(!s) return null; const m=String(s).trim().match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
  if(!m) return null; const d=+m[1], mo=+m[2], y=+m[3];
  const dt=new Date(Date.UTC(y,mo-1,d));
  if(dt.getUTCFullYear()!==y||dt.getUTCMonth()+1!==mo||dt.getUTCDate()!==d) return null;
  return {ts:dt.getTime(), y, m:mo, d};
}
function makeId(o){
  const key=[String(o.dateStr||''),String(o.event||''),String(o.details||''),String(o.place||'')].join('|').toLowerCase();
  try{ return btoa(unescape(encodeURIComponent(key))).replace(/=+$/,''); }catch{ return key; }
}
function genUid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,8)); }

/* compress images before storing (limits size) */
async function compressImageToBlob(file, maxDim=1280, quality=0.72){
  const url=URL.createObjectURL(file);
  const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; });
  URL.revokeObjectURL(url);
  const scale=Math.min(1, maxDim/Math.max(img.width,img.height));
  const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return await new Promise(res=> cvs.toBlob(b=>res(b), 'image/jpeg', quality) );
}

/* Resolve idb refs in a block */
async function resolveIdbMedia(root){
  for(const img of root.querySelectorAll('img[data-idb]')){
    const id = img.dataset.idb; try{
      const blob = await idbGetBlob(id); const url = URL.createObjectURL(blob);
      img.src = url;
    }catch{}
  }
  for(const aud of root.querySelectorAll('audio')){
    let changed=false;
    for(const src of aud.querySelectorAll('source[data-idb]')){
      const id = src.dataset.idb; try{
        const blob = await idbGetBlob(id); const url = URL.createObjectURL(blob);
        src.src = url; changed = true;
      }catch{}
    }
    if(changed) aud.load();
  }
}

/* ========= NORMALIZATION ========= */
function normalize(item, asLocal){
  const dRaw=item.date ?? item.Date ?? item['dd-mm-yyyy'] ?? item.date_ddmmyyyy ?? null;
  const p=parseDDMMYYYY(dRaw); if(!p) return {dateTs:null};
  const {ts,y,m,d}=p;
  const obj={
    dateTs:ts, dateStr:[pad(d),pad(m),y].join('-'), year:y, month:m, day:d,
    event:item.event ?? item.Event ?? item.title ?? item.Title ?? null,
    details:item.details ?? item.Details ?? item.desc ?? item.Description ?? null,
    place:item.place ?? item.Place ?? item.location ?? item.Location ?? null,
    images:item.images ?? item.image ?? null,
    audio:item.audio ?? item.audios ?? null
  };
  obj._id = makeId(obj);
  if(asLocal){ obj._local=true; obj._uid=genUid(); }
  return obj;
}
function readLocalAdds(){ try{ const arr=JSON.parse(localStorage.getItem(LSK)||'[]'); return Array.isArray(arr)?arr:[]; }catch{ return []; } }
function saveLocalAdds(arr){ localStorage.setItem(LSK, JSON.stringify(arr)); }

/* ========= BOOT ========= */
startBtn.addEventListener('click', init);
async function init(){
  startBtn.disabled=true; loadingEl.style.display='block'; errEl.textContent='';
  try{
    let base=[]; try{ const r=await fetch(JSON_URL,{cache:'no-store'}); if(r.ok) base=await r.json(); }catch{}
    if(!Array.isArray(base)) base=[];
    const normBase = base.map(x=>normalize(x,false)).filter(x=>x.dateTs!=null);
    const localAdds = readLocalAdds();
    master = normBase.filter(x=>!delSet.has(x._id)).concat(localAdds);
    sortMaster(); refillPool();
    startScreen.style.display='none';
    setupInfinite(); loadMore();
  }catch(e){
    loadingEl.style.display='none'; startBtn.disabled=false; errEl.textContent='Unable to start: '+e.message;
  }
}
function sortMaster(){ master.sort((a,b)=>a.dateTs-b.dateTs); }
function refillPool(){ pool = pool.concat(master); }
function setupInfinite(){
  if(io) io.disconnect();
  io=new IntersectionObserver((en)=>{ if(en.some(e=>e.isIntersecting)) loadMore(); },{root:null,rootMargin:'800px 0px',threshold:0});
  io.observe(sentinel);
}
function loadMore(){ if(pool.length<CHUNK) refillPool(); pool.splice(0,CHUNK).forEach(addCard); }

/* ========= RENDER ========= */
function addCard(d){
  const card=el('button','card'); card.dataset.idx="0";
  const pill=el('div','pill'); const front=el('div','side front'); const back=el('div','side back');

  const seq=[...statesBase]; if(hasImages(d)) seq.push('image'); if(hasAudio(d)) seq.push('audio');
  cardSeq.set(card,seq);

  front.innerHTML = renderFace(seq[0], d); resolveIdbMedia(front);
  back.innerHTML  = renderFace(seq[1]??seq[0], d); resolveIdbMedia(back);
  pill.append(front,back);

  const chip=el('div','dateChip', d.dateStr);
  const btnRow=el('div','btnRow');
  const editBtn=el('button','cardBtn','âœŽ Edit');
  editBtn.addEventListener('click', ev=>{ ev.stopPropagation(); openModal('edit', d); });
  const delBtn=el('button','cardBtn del','ðŸ—‘ Delete');
  delBtn.addEventListener('click', ev=>{ ev.stopPropagation(); handleDelete(d); });
  btnRow.append(editBtn, delBtn);

  card.append(pill,chip,btnRow);

  card.addEventListener('click', ev=>{
    if(ev.target.tagName==='AUDIO'||ev.target.closest('.audioWrap')) return;
    const seq=cardSeq.get(card)||['date']; let i=Number(card.dataset.idx);
    const next=(i+1)%seq.length, face=seq[next], showBack = next%2===1;
    (showBack?back:front).innerHTML = renderFace(face,d);
    resolveIdbMedia(showBack?back:front);
    card.classList.toggle('flipped', showBack);
    card.dataset.idx=String(next);
  });

  timeline.appendChild(card);
}
function faceWrap(inner,hint){ return `<div>${inner}<div class="hint">${esc(hint)}</div></div>`; }
function renderFace(kind,d){
  if(kind==='date')   return faceWrap(`<div style="font-size:26px;font-weight:800">${esc(d.dateStr)}</div>`, 'Tap to see event');
  if(kind==='event')  return faceWrap(`<div style="font-size:20px;font-weight:800">${esc(d.event||'â€”')}</div>`, 'Tap for details');
  if(kind==='details')return faceWrap(`<div style="font-size:16px;font-weight:700;max-width:90%">${esc(d.details||'â€”')}</div>`, 'Tap for place');
  if(kind==='place')  return faceWrap(`<div style="font-size:18px;font-weight:800">${esc(d.place||'â€”')}</div>`, hasImages(d)?'Tap for image':(hasAudio(d)?'Tap for audio':'Tap to return to date'));
  if(kind==='image')  return faceWrap(renderImage(d) || `<div class="mediaNote">No image</div>`, hasAudio(d)?'Tap for audio':'Tap to return to date');
  if(kind==='audio')  return faceWrap(renderAudio(d) || `<div class="mediaNote">No audio</div>`, 'Tap to return to date');
  return 'â€”';
}
function renderImage(d){
  const imgs=toArr(d.images||d.image); if(!imgs.length) return '';
  const first=String(imgs[0]);
  const more=imgs.length>1?`<div class="mediaNote">+${imgs.length-1} more image(s)</div>`:'';
  if(first.startsWith('idb:')) return `<div class="mediaBox"><img class="mediaImg" data-idb="${first.slice(4)}" alt="${esc(d.event||d.dateStr)}">${more}</div>`;
  return `<div class="mediaBox"><img class="mediaImg" src="${first}" alt="${esc(d.event||d.dateStr)}">${more}</div>`;
}
function renderAudio(d){
  const auds=toArr(d.audio||d.audios||d.sound); if(!auds.length) return '';
  const parts=auds.map(u=> u.startsWith('idb:') ? `<source data-idb="${u.slice(4)}">` : `<source src="${u}">`).join('');
  return `<div class="audioWrap"><audio controls preload="none">${parts}</audio></div>`;
}
const hasImages=d=>toArr(d.images||d.image).length>0;
const hasAudio =d=>toArr(d.audio||d.audios||d.sound).length>0;

/* ========= DELETE ========= */
async function handleDelete(d){
  if(!confirm(`Delete ${d.dateStr}?`)) return;

  if(d._local){
    const adds=readLocalAdds();
    const idx=adds.findIndex(x=>x._uid===d._uid);
    if(idx>-1){ await deleteIdbRefs(adds[idx]); adds.splice(idx,1); saveLocalAdds(adds); }
  }else{
    delSet.add(d._id); localStorage.setItem(LSKD, JSON.stringify([...delSet]));
  }
  master = master.filter(x=>x!==d);
  rebuild();
}
async function deleteIdbRefs(obj){
  const imgs=toArr(obj.images||obj.image); for(const u of imgs){ if(typeof u==='string' && u.startsWith('idb:')){ try{ await idbDelete(u.slice(4)); }catch{} } }
  const auds=toArr(obj.audio||obj.audios); for(const u of auds){ if(typeof u==='string' && u.startsWith('idb:')){ try{ await idbDelete(u.slice(4)); }catch{} } }
}

/* ========= ADD / EDIT ========= */
addBtn.addEventListener('click', ()=> openModal('add'));
cancelBtn.addEventListener('click', ()=> modal.style.display='none');
modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });

function openModal(mode, obj=null){
  editMode = (mode==='edit');
  editingObj = obj;
  modalTitle.textContent = editMode ? 'Edit card' : 'Add card';
  modalErr.textContent = '';

  // preset fields
  if(editMode && obj){
    fDate.value = obj.dateStr;
    fPlace.value = obj.place || '';
    fEvent.value = obj.event || '';
    fDetails.value = obj.details || '';
    editImgs = [...toArr(obj.images||obj.image)];
    editAuds = [...toArr(obj.audio||obj.audios||obj.sound)];
  }else{
    fDate.value=''; fPlace.value=''; fEvent.value=''; fDetails.value='';
    editImgs = []; editAuds = [];
  }
  fImgUrls.value=''; fAudUrls.value=''; fImgFiles.value=''; fAudFiles.value='';

  renderChips(chipsImg, editImgs, 'img');
  renderChips(chipsAud, editAuds, 'aud');

  modal.style.display='flex'; fDate.focus();
}

function renderChips(container, arr, kind){
  container.innerHTML='';
  if(!arr.length){ container.innerHTML='<span class="small">â€” none â€”</span>'; return; }
  arr.forEach((u, idx)=>{
    const chip = document.createElement('span'); chip.className='chip';
    const label = (typeof u==='string' && u.startsWith('idb:')) ? `${kind.toUpperCase()}(IDB)` : (String(u).length>32?('â€¦'+String(u).slice(-32)):String(u));
    chip.innerHTML = `<b>${label}</b> <button title="remove" aria-label="remove">Ã—</button>`;
    chip.querySelector('button').addEventListener('click', ()=>{ arr.splice(idx,1); renderChips(container, arr, kind); });
    container.appendChild(chip);
  });
}

saveBtn.addEventListener('click', async ()=>{
  try{
    modalErr.textContent='';
    const p=parseDDMMYYYY(fDate.value.trim()); if(!p) throw new Error('Use dd-mm-yyyy (e.g., 26-01-1950)');
    const {ts,y,m,d}=p;

    // URL lists
    const imgUrls=splitUrls(fImgUrls.value);
    const audUrls=splitUrls(fAudUrls.value);

    // New attachments -> IDB refs
    const idbImgs=[], idbAuds=[];
    for(const file of [...(fImgFiles.files||[])]){ const blob=await compressImageToBlob(file); const id=await idbPutBlob('img', blob); idbImgs.push('idb:'+id); }
    for(const file of [...(fAudFiles.files||[])]){ const id=await idbPutBlob('aud', file); idbAuds.push('idb:'+id); }

    const updated = {
      dateTs:ts, dateStr:[pad(d),pad(m),y].join('-'), year:y, month:m, day:d,
      event:(fEvent.value||'').trim()||null,
      details:(fDetails.value||'').trim()||null,
      place:(fPlace.value||'').trim()||null,
      images:[...editImgs, ...imgUrls, ...idbImgs],
      audio:[...editAuds, ...audUrls, ...idbAuds]
    };
    updated._id = makeId(updated);

    if(editMode && editingObj){
      if(editingObj._local){
        // update in local store
        const adds=readLocalAdds();
        const ix=adds.findIndex(x=>x._uid===editingObj._uid);
        if(ix>-1){
          // delete any removed IDB media
          await cleanupRemovedMedia(adds[ix], updated);
          adds[ix] = {...adds[ix], ...updated};
          saveLocalAdds(adds);
        }
        // update in master
        Object.assign(editingObj, updated);
      }else{
        // editing a base card: hide original, add a local clone
        delSet.add(editingObj._id); localStorage.setItem(LSKD, JSON.stringify([...delSet]));
        const clone = {_local:true,_uid:genUid(), ...updated};
        const adds=readLocalAdds(); adds.push(clone); saveLocalAdds(adds);
        master = master.filter(x=>x!==editingObj).concat(clone);
      }
    }else{
      // brand new card
      const newItem = {_local:true,_uid:genUid(), ...updated};
      const adds=readLocalAdds(); adds.push(newItem); saveLocalAdds(adds);
      master.push(newItem);
    }

    sortMaster(); rebuild();
    modal.style.display='none';
  }catch(e){ modalErr.textContent=e.message; }
});

/* delete IDB blobs that were removed during edit (only for local items) */
async function cleanupRemovedMedia(prev, next){
  const prevImgs = new Set(toArr(prev.images||prev.image));
  for(const u of toArr(next.images)){ prevImgs.delete(u); }
  for(const u of prevImgs){ if(typeof u==='string' && u.startsWith('idb:')){ try{ await idbDelete(u.slice(4)); }catch{} } }

  const prevAuds = new Set(toArr(prev.audio||prev.audios));
  for(const u of toArr(next.audio)){ prevAuds.delete(u); }
  for(const u of prevAuds){ if(typeof u==='string' && u.startsWith('idb:')){ try{ await idbDelete(u.slice(4)); }catch{} } }
}

/* ========= EXPORT / IMPORT ========= */
exportBtn.addEventListener('click', async ()=>{
  const out=[];
  for(const x of master){
    const one={ date:x.dateStr, event:x.event, details:x.details, place:x.place, images:[], audio:[] };
    for(const u of toArr(x.images||x.image)){
      if(typeof u==='string' && u.startsWith('idb:')) one.images.push(await idbToDataURL(u.slice(4)));
      else if(u) one.images.push(u);
    }
    for(const u of toArr(x.audio||x.audios)){
      if(typeof u==='string' && u.startsWith('idb:')) one.audio.push(await idbToDataURL(u.slice(4)));
      else if(u) one.audio.push(u);
    }
    if(!one.images.length) delete one.images;
    if(!one.audio.length) delete one.audio;
    out.push(one);
  }
  const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cards-export.json'; a.click(); URL.revokeObjectURL(a.href);
});

importInp.addEventListener('change', async ()=>{
  const file=importInp.files?.[0]; if(!file) return;
  try{
    const txt=await file.text(); const arr=JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON must be an array');
    const newOnes=[];
    for(const raw of arr){
      const n=normalize(raw,true); if(!n.dateTs) continue;
      const imgs=[]; for(const u of toArr(n.images)){ if(typeof u==='string' && u.startsWith('data:')){ const blob=await (await fetch(u)).blob(); const id=await idbPutBlob('img', blob); imgs.push('idb:'+id);} else imgs.push(u); }
      const auds=[]; for(const u of toArr(n.audio)){ if(typeof u==='string' && u.startsWith('data:')){ const blob=await (await fetch(u)).blob(); const id=await idbPutBlob('aud', blob); auds.push('idb:'+id);} else imgs.push(u); }
      n.images=imgs.length?imgs:null; n.audio=auds.length?auds:null; n._uid=genUid(); newOnes.push(n);
    }
    const adds=readLocalAdds(); adds.push(...newOnes); saveLocalAdds(adds);
    master=master.concat(newOnes); sortMaster(); rebuild();
    alert('Imported '+newOnes.length+' cards.');
  }catch(e){ alert('Import failed: '+e.message); }
  importInp.value='';
});

/* ========= Misc ========= */
function rebuild(){ timeline.innerHTML=''; pool.length=0; refillPool(); loadMore(); }
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.style.display==='flex') modal.style.display='none'; });
</script>
</body>
</html>
