<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Flash Cards — Date-wise + Add from UI</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<style>
:root{--bg:#0f1220;--card:#181c2f;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f;--bad:#ff7575}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;-webkit-tap-highlight-color:transparent}
header,footer{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.wrap{max-width:900px;margin:0 auto;padding:8px 16px 80px}
.btn{appearance:none;border:1px solid var(--accent);background:transparent;color:var(--ink);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.btn:active{transform:scale(.98)}
.badge{display:inline-flex;gap:6px;align-items:center;padding:3px 10px;border:1px solid var(--line);border-radius:9999px;color:var(--muted);font-size:12px}

/* Start screen */
#startScreen{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:5;border-top:6px solid var(--accent);border-bottom:6px solid var(--accent)}
.start-btn{user-select:none;cursor:pointer;min-width:220px;padding:18px 28px;border:3px solid var(--accent);border-radius:9999px;font-weight:700;font-size:22px;background:transparent;color:var(--ink);box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 9999px rgba(108,168,255,.06)}
#loading{margin-top:14px;text-align:center;color:var(--muted);font-size:14px}
#err{margin-top:10px;color:var(--bad);font-weight:600;font-size:14px;text-align:center;max-width:90%}

/* Timeline + cards */
.timeline{position:relative;margin:8px auto}
.timeline:before{content:"";position:absolute;left:calc(50% - 2px);top:0;bottom:0;width:4px;background:var(--line);border-radius:2px;opacity:.8}
.card{position:relative;display:flex;justify-content:center;align-items:center;width:min(92%,560px);margin:28px auto;padding:0;border:none;background:transparent;perspective:1000px}
.card::after{content:"";position:absolute;left:50%;bottom:-28px;transform:translateX(-50%);width:2px;height:28px;background:var(--line)}
.card:last-child::after{display:none}
.pill{position:relative;width:100%;min-height:92px;border-radius:9999px;border:3px solid var(--accent);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 9999px rgba(108,168,255,.05);transform-style:preserve-3d;transition:transform .45s cubic-bezier(.2,.7,.2,1)}
.card.flipped .pill{transform:rotateY(180deg)}
.side{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:14px 22px;text-align:center;font-size:22px;font-weight:700;backface-visibility:hidden;border-radius:9999px}
.side.back{transform:rotateY(180deg)}
.side .hint{font-weight:600;font-size:12px;color:var(--muted)}
.dateChip{position:absolute;top:-18px;left:50%;transform:translateX(-50%);background:var(--bg);color:var(--ok);border:2px solid var(--ok);font-weight:700;font-size:12px;padding:2px 10px;border-radius:9999px;white-space:nowrap}
#sentinel{height:1px}

/* Media */
.mediaBox{width:100%;max-width:460px}
.mediaImg{display:block;margin:0 auto;border-radius:14px;border:2px solid var(--line);max-height:200px;width:auto;max-width:100%;object-fit:cover;background:#0b1224}
.mediaNote{font:600 12px/1.2 system-ui;color:var(--muted);margin-top:4px}
.audioWrap{width:100%;max-width:460px}
audio{width:100%;outline:none;border-radius:10px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10;padding:20px}
.modalCard{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:720px;width:100%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
.modal h2{margin:0 0 8px 0;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid>label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
input[type="text"],textarea{background:#0c1328;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font:inherit}
textarea{min-height:70px;resize:vertical}
.row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--line);margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>Flash Cards — Date-wise</h1>
  <div class="tools" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <button id="addBtn" class="btn">＋ Add</button>
    <button id="exportBtn" class="btn">Export JSON</button>
    <label class="btn" style="cursor:pointer">
      Import JSON<input id="importInp" type="file" accept=".json,application/json" hidden>
    </label>
    <span class="badge">Tap card: Date → Event → Details → Place</span>
  </div>
</header>

<div class="wrap">
  <div id="timeline" class="timeline"></div>
  <div id="sentinel"></div>
</div>

<footer>
  <div class="badge">Loads <code>cards.json</code> + your local adds (saved in browser)</div>
</footer>

<!-- START OVERLAY -->
<div id="startScreen">
  <div style="text-align:center">
    <button id="startBtn" class="start-btn">Start</button>
    <div id="loading" style="margin-top:10px;color:#9aa3c7;display:none">Loading cards.json…</div>
    <div id="err"></div>
  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="modalCard">
    <h2 id="modalTitle">Add card</h2>
    <div class="grid">
      <label>Date (dd-mm-yyyy)
        <input id="fDate" type="text" placeholder="e.g., 26-01-1950" inputmode="numeric">
      </label>
      <label>Place
        <input id="fPlace" type="text" placeholder="City / Country">
      </label>
      <label style="grid-column:1/-1">Event / Title
        <input id="fEvent" type="text" placeholder="What happened?">
      </label>
      <label style="grid-column:1/-1">Details / Notes
        <textarea id="fDetails" placeholder="1–3 lines of context"></textarea>
      </label>
      <label>Image URLs (comma-separated)
        <input id="fImgUrls" type="text" placeholder="https://... , https://...">
      </label>
      <label>Audio URLs (comma-separated)
        <input id="fAudUrls" type="text" placeholder="https://... , https://...">
      </label>
      <label>Attach Images (optional)
        <input id="fImgFiles" type="file" accept="image/*" multiple>
        <span class="small">Attached files are embedded as data-URLs (saved locally).</span>
      </label>
      <label>Attach Audio (optional)
        <input id="fAudFiles" type="file" accept="audio/*" multiple>
        <span class="small">Use .mp3/.m4a for iPad.</span>
      </label>
    </div>
    <hr>
    <div id="modalErr" class="small" style="color:var(--bad)"></div>
    <div class="row">
      <button id="cancelBtn" class="btn">Cancel</button>
      <button id="saveBtn" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
/* ===== SETTINGS ===== */
const JSON_URL = 'cards.json';            // optional; app also works with only local adds
const CHUNK = 12;
const states = ["date","event","details","place"];
const LSK = 'flashcards_datewise_user_v1';

/* ===== ELs ===== */
const startBtn=document.getElementById('startBtn'), startScreen=document.getElementById('startScreen');
const loadingEl=document.getElementById('loading'), errEl=document.getElementById('err');
const timeline=document.getElementById('timeline'), sentinel=document.getElementById('sentinel');
const addBtn=document.getElementById('addBtn'), exportBtn=document.getElementById('exportBtn'), importInp=document.getElementById('importInp');
const modal=document.getElementById('modal'), modalTitle=document.getElementById('modalTitle'), modalErr=document.getElementById('modalErr');
const fDate=document.getElementById('fDate'), fPlace=document.getElementById('fPlace'),
      fEvent=document.getElementById('fEvent'), fDetails=document.getElementById('fDetails'),
      fImgUrls=document.getElementById('fImgUrls'), fAudUrls=document.getElementById('fAudUrls'),
      fImgFiles=document.getElementById('fImgFiles'), fAudFiles=document.getElementById('fAudFiles');
const cancelBtn=document.getElementById('cancelBtn'), saveBtn=document.getElementById('saveBtn');

/* ===== DATA ===== */
let master=[]; // normalized + sorted
let pool=[];   // loader queue
let io=null;

/* ===== BOOT ===== */
startBtn.addEventListener('click', init);
async function init(){
  startBtn.disabled=true; loadingEl.style.display='block'; errEl.textContent='';
  try{
    let base=[];
    try{
      const res=await fetch(JSON_URL,{cache:'no-store'});
      if(res.ok){ base = await res.json(); }
    }catch(_){ /* ok if no cards.json */ }
    if(!Array.isArray(base)) base = [];
    const localAdds = readLocalAdds();     // already normalized objects
    // normalize base (might be unnormalized)
    const normBase = base.map(normalize).filter(x=>x.dateTs!=null);
    master = normBase.concat(localAdds);
    sortMaster();
    refillPool();
    startScreen.style.display='none';
    setupInfiniteScroll();
    loadMore();
  }catch(e){
    loadingEl.style.display='none'; startBtn.disabled=false;
    errEl.textContent='Unable to start: '+e.message;
  }
}

/* ===== INFINITE SCROLL ===== */
function setupInfiniteScroll(){
  if(io) io.disconnect();
  io = new IntersectionObserver((entries)=>{ if(entries.some(e=>e.isIntersecting)) loadMore(); },
                                {root:null,rootMargin:'800px 0px',threshold:0});
  io.observe(sentinel);
}
function loadMore(){
  if(pool.length<CHUNK) refillPool();
  pool.splice(0,CHUNK).forEach(addCard);
}
function refillPool(){ pool = pool.concat(master); } // chronological loop
function sortMaster(){ master.sort((a,b)=>a.dateTs-b.dateTs); }

/* ===== RENDER ===== */
function addCard(d){
  const card = el('button','card'); card.dataset.stateIndex="0";
  const pill = el('div','pill'); const front = el('div','side front'); const back = el('div','side back');
  front.innerHTML = renderFace('date',d); back.innerHTML = renderFace('event',d); pill.append(front,back);
  const chip = el('div','dateChip', d.dateStr); card.append(pill,chip);

  card.addEventListener('click', (ev)=>{
    if(ev.target.tagName==='AUDIO' || ev.target.closest('.audioWrap')) return;
    let idx=Number(card.dataset.stateIndex); const next=(idx+1)%states.length;
    const showBack = next%2===1; (showBack?back:front).innerHTML = renderFace(states[next], d);
    card.classList.toggle('flipped', showBack); card.dataset.stateIndex=String(next);
  });
  timeline.appendChild(card);
}
function renderFace(kind,d){
  const imgHtml = renderImage(d), audHtml = renderAudio(d);
  if(kind==='date')   return `<div><div style="font-size:26px;font-weight:800">${esc(d.dateStr)}</div>${imgHtml}${audHtml}<div class="hint">Tap to see event</div></div>`;
  if(kind==='event')  return `<div><div style="font-size:20px;font-weight:800">${esc(d.event||'—')}</div>${imgHtml}${audHtml}<div class="hint">Tap for details</div></div>`;
  if(kind==='details')return `<div><div style="font-size:16px;font-weight:700;max-width:90%">${esc(d.details||'—')}</div>${imgHtml}${audHtml}<div class="hint">Tap for place</div></div>`;
  return `<div><div style="font-size:18px;font-weight:800">${esc(d.place||'—')}</div>${imgHtml}${audHtml}<div class="hint">Tap to return to date</div></div>`;
}
function renderImage(d){
  const arr = toArr(d.image||d.images); if(!arr.length) return '';
  const src = String(arr[0]); const more = arr.length>1?`<div class="mediaNote">+${arr.length-1} more image(s)</div>`:'';
  return `<div class="mediaBox"><img class="mediaImg" loading="lazy" decoding="async" src="${src}" alt="${esc(d.event||d.details||d.place||d.dateStr)}">${more}</div>`;
}
function renderAudio(d){
  const arr = toArr(d.audio||d.audios||d.sound); if(!arr.length) return '';
  return `<div class="audioWrap"><audio controls preload="none">${arr.map(u=>`<source src="${u}">`).join('')}</audio></div>`;
}

/* ===== ADD FROM UI ===== */
addBtn.addEventListener('click', ()=>{ openModal(); });

cancelBtn.addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

function openModal(){
  modalTitle.textContent='Add card';
  modalErr.textContent=''; fDate.value=''; fPlace.value=''; fEvent.value='';
  fDetails.value=''; fImgUrls.value=''; fAudUrls.value=''; fImgFiles.value=''; fAudFiles.value='';
  modal.style.display='flex'; fDate.focus();
}
function closeModal(){ modal.style.display='none'; }

saveBtn.addEventListener('click', async ()=>{
  try{
    modalErr.textContent='';
    const dateStr = fDate.value.trim();
    const parsed = parseDDMMYYYY(dateStr);
    if(!parsed) throw new Error('Enter date as dd-mm-yyyy, e.g., 26-01-1950');
    const {ts,y,m,d} = parsed;

    const imgs = splitUrls(fImgUrls.value);
    const auds = splitUrls(fAudUrls.value);

    // read attached files as data-URLs
    const imgData = await readFilesAsDataUrls(fImgFiles.files);
    const audData = await readFilesAsDataUrls(fAudFiles.files);

    const item = {
      dateTs: ts, dateStr: [pad(d),pad(m),y].join('-'),
      year:y, month:m, day:d,
      event: valOrNull(fEvent.value), details: valOrNull(fDetails.value), place: valOrNull(fPlace.value),
      images: imgs.concat(imgData), audio: auds.concat(audData),
      _local:true
    };

    // persist to localStorage
    const adds = readLocalAdds();
    adds.push(item);
    localStorage.setItem(LSK, JSON.stringify(adds));

    // merge into master + rerender in order
    master.push(item); sortMaster(); rebuildTimeline();

    closeModal();
  }catch(err){ modalErr.textContent = err.message; }
});

function rebuildTimeline(){
  // reset rendered UI (quick for hundreds of items)
  timeline.innerHTML='';
  pool.length = 0;
  refillPool();
  loadMore();
}

/* ===== EXPORT / IMPORT ===== */
exportBtn.addEventListener('click', ()=>{
  const exportData = master.map(x=>({
    date: x.dateStr, event:x.event, details:x.details, place:x.place,
    images: x.images || x.image || null, audio: x.audio || null
  }));
  const blob = new Blob([JSON.stringify(exportData,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'cards-export.json'; a.click(); URL.revokeObjectURL(a.href);
});

importInp.addEventListener('change', async ()=>{
  const file = importInp.files?.[0]; if(!file) return;
  try{
    const text = await file.text(); const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('JSON must be an array');
    const adds = readLocalAdds();
    const newOnes = arr.map(normalize).filter(x=>x.dateTs!=null);
    adds.push(...newOnes);
    localStorage.setItem(LSK, JSON.stringify(adds));
    master = master.concat(newOnes); sortMaster(); rebuildTimeline();
    alert('Imported '+newOnes.length+' cards (saved locally).');
  }catch(e){ alert('Import failed: '+e.message); }
  importInp.value='';
});

/* ===== HELPERS ===== */
function readLocalAdds(){
  try{
    const raw = JSON.parse(localStorage.getItem(LSK) || '[]');
    // they are already normalized (we store normalized), but normalize again safely:
    return Array.isArray(raw) ? raw.map(normalizeLocal).filter(x=>x.dateTs!=null) : [];
  }catch{ return []; }
}

function normalize(item){
  // For base JSON (fields may be arbitrary)
  const dateRaw = item.date ?? item.Date ?? item['dd-mm-yyyy'] ?? item.date_ddmmyyyy ?? null;
  const p = parseDDMMYYYY(dateRaw); if(!p) return {dateTs:null};
  const {ts,y,m,d} = p;
  return {
    dateTs:ts, dateStr:[pad(d),pad(m),y].join('-'), year:y, month:m, day:d,
    event: item.event ?? item.Event ?? item.title ?? item.Title ?? null,
    details: item.details ?? item.Details ?? item.desc ?? item.Description ?? null,
    place: item.place ?? item.Place ?? item.location ?? item.Location ?? null,
    images: item.images ?? item.image ?? null,
    audio: item.audio ?? item.audios ?? null
  };
}
function normalizeLocal(item){
  // Local adds we saved already have normalized fields; keep them
  if(item.dateTs && item.dateStr) return item;
  return normalize(item);
}

function parseDDMMYYYY(s){
  if(!s) return null;
  const m = String(s).trim().match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
  if(!m) return null;
  const d = +m[1], mo = +m[2], y = +m[3];
  const dt = new Date(Date.UTC(y, mo-1, d));
  if(dt.getUTCFullYear()!==y || dt.getUTCMonth()+1!==mo || dt.getUTCDate()!==d) return null;
  return {ts:dt.getTime(), y, m:mo, d};
}
const pad=n=>(n<10?'0':'')+n;
const esc=s=>String(s==null?'':s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const toArr=v=>v==null?[]:(Array.isArray(v)?v:[v]);
const el=(t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;};
const valOrNull=v=>{v=String(v||'').trim(); return v||null;};
const splitUrls=str=>!str?[]:str.split(',').map(s=>s.trim()).filter(Boolean);

/* read any FileList as data-URLs */
async function readFilesAsDataUrls(fileList){
  if(!fileList || !fileList.length) return [];
  const tasks = [...fileList].map(f => new Promise((resolve,reject)=>{
    const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=()=>reject(fr.error); fr.readAsDataURL(f);
  }));
  return Promise.all(tasks);
}

/* Start overlay control */
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.style.display==='flex') closeModal(); });

</script>
</body>
</html>
