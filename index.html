<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Flash Card App — Date-wise (dd-mm-yyyy)</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<style>
:root{--bg:#0f1220;--card:#181c2f;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;-webkit-tap-highlight-color:transparent}
header,footer{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.wrap{max-width:900px;margin:0 auto;padding:8px 16px 80px}

/* Start screen */
#startScreen{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:5;border-top:6px solid var(--accent);border-bottom:6px solid var(--accent)}
.start-btn{user-select:none;cursor:pointer;min-width:220px;padding:18px 28px;border:3px solid var(--accent);border-radius:9999px;font-weight:700;font-size:22px;background:transparent;color:var(--ink);box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 9999px rgba(108,168,255,.06)}
#loading{margin-top:14px;text-align:center;color:var(--muted);font-size:14px}
#err{margin-top:10px;color:#ff7575;font-weight:600;font-size:14px;text-align:center;max-width:90%}

/* Timeline + cards */
.timeline{position:relative;margin:8px auto}
.timeline:before{content:"";position:absolute;left:calc(50% - 2px);top:0;bottom:0;width:4px;background:var(--line);border-radius:2px;opacity:.8}
.card{position:relative;display:flex;justify-content:center;align-items:center;width:min(92%,560px);margin:28px auto;padding:0;border:none;background:transparent;perspective:1000px}
.card::after{content:"";position:absolute;left:50%;bottom:-28px;transform:translateX(-50%);width:2px;height:28px;background:var(--line)}
.card:last-child::after{display:none}
.pill{position:relative;width:100%;min-height:92px;border-radius:9999px;border:3px solid var(--accent);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 9999px rgba(108,168,255,.05);transform-style:preserve-3d;transition:transform .45s cubic-bezier(.2,.7,.2,1)}
.card.flipped .pill{transform:rotateY(180deg)}
.side{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:14px 22px;text-align:center;font-size:22px;font-weight:700;backface-visibility:hidden;border-radius:9999px}
.side.back{transform:rotateY(180deg)}
.side .hint{font-weight:600;font-size:12px;color:var(--muted)}
.dateChip{position:absolute;top:-18px;left:50%;transform:translateX(-50%);background:var(--bg);color:var(--ok);border:2px solid var(--ok);font-weight:700;font-size:12px;padding:2px 10px;border-radius:9999px;white-space:nowrap}
#sentinel{height:1px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:3px 10px;border:1px solid var(--line);border-radius:9999px;color:var(--muted);font-size:12px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin:8px 0}

/* Media */
.mediaBox{width:100%;max-width:460px}
.mediaImg{display:block;margin:0 auto;border-radius:14px;border:2px solid var(--line);max-height:200px;width:auto;max-width:100%;object-fit:cover;background:#0b1224}
.mediaNote{font:600 12px/1.2 system-ui;color:var(--muted);margin-top:4px}
.audioWrap{width:100%;max-width:460px}
audio{width:100%;outline:none;border-radius:10px}
.hidden{display:none!important}
</style>
</head>
<body>
<header>
  <h1>Flash Card App — Date-wise</h1>
  <div class="controls"><span class="badge">Tap: Date → Event → Details → Place</span></div>
</header>

<div class="wrap">
  <div id="timeline" class="timeline"></div>
  <div id="sentinel"></div>
</div>

<footer><div class="badge">Data: <code>cards.json</code> (dd-mm-yyyy)</div></footer>

<!-- START OVERLAY -->
<div id="startScreen">
  <div style="text-align:center">
    <button id="startBtn" class="start-btn">Start</button>
    <div id="loading" class="hidden">Loading cards.json…</div>
    <div id="err"></div>
  </div>
</div>

<script>
/* ====== SETTINGS ====== */
const JSON_URL = 'cards.json';
const CHUNK = 12;             // cards per batch
const LOOP_IN_ORDER = true;   // keep timeline chronological when looping
const states = ["date","event","details","place"];

/* ====== ELEMENTS ====== */
const startBtn   = document.getElementById('startBtn');
const startPanel = document.getElementById('startScreen');
const loadingEl  = document.getElementById('loading');
const errEl      = document.getElementById('err');
const timeline   = document.getElementById('timeline');
const sentinel   = document.getElementById('sentinel');

/* ====== DATA ====== */
let master = []; // full, sorted list
let pool   = []; // queue used by loader

startBtn.addEventListener('click', init);

async function init(){
  startBtn.disabled = true; loadingEl.classList.remove('hidden'); errEl.textContent='';
  try{
    const res = await fetch(JSON_URL,{cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.json();
    if(!Array.isArray(raw)) throw new Error('cards.json must be an array');

    // normalize + validate date strings
    master = raw.map(normalize).filter(x=>x.dateTs!=null);
    if(master.length===0) throw new Error('No valid dd-mm-yyyy dates found');

    // sort chronologically
    master.sort((a,b)=>a.dateTs - b.dateTs);

    // prepare loader pool
    refillPool();

    // launch
    startPanel.style.display='none';
    boot();
  }catch(e){
    loadingEl.classList.add('hidden'); startBtn.disabled=false;
    errEl.textContent = `Could not load cards.json (${e.message}). Ensure dates are in dd-mm-yyyy (e.g., 26-01-1950).`;
  }
}

function boot(){
  loadMore();
  const io = new IntersectionObserver((entries)=>{
    if(entries.some(e=>e.isIntersecting)) loadMore();
  },{root:null,rootMargin:'800px 0px',threshold:0});
  io.observe(sentinel);
}

function loadMore(){
  if(pool.length < CHUNK) refillPool();
  pool.splice(0, CHUNK).forEach(addCard);
}

function refillPool(){
  const copy = master.slice();
  if(!LOOP_IN_ORDER){
    for(let i=copy.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [copy[i],copy[j]]=[copy[j],copy[i]]; }
  }
  pool = pool.concat(copy);
}

/* ====== RENDER ====== */
function addCard(d){
  const card = el('button','card'); card.dataset.stateIndex="0";
  const pill = el('div','pill');
  const front = el('div','side front');
  const back  = el('div','side back');

  front.innerHTML = renderFace('date', d);
  back.innerHTML  = renderFace('event', d);
  pill.append(front, back);

  const chip = el('div','dateChip', d.dateStr);  // full date chip
  card.append(pill, chip);

  card.addEventListener('click', (ev)=>{
    if(ev.target.tagName === 'AUDIO' || ev.target.closest('.audioWrap')) return; // don't flip when using audio
    let idx = Number(card.dataset.stateIndex);
    const nextIdx = (idx + 1) % states.length, nextFace = states[nextIdx];
    const showBack = nextIdx % 2 === 1;
    (showBack ? back : front).innerHTML = renderFace(nextFace, d);
    card.classList.toggle('flipped', showBack);
    card.dataset.stateIndex = String(nextIdx);
  });

  timeline.appendChild(card);
}

function renderFace(kind, d){
  const imgHtml = renderImage(d);
  const audioHtml = renderAudio(d);
  if(kind==='date'){
    return `
      <div>
        <div style="font-size:26px;font-weight:800">${esc(d.dateStr)}</div>
        ${imgHtml}${audioHtml}
        <div class="hint">Tap to see event</div>
      </div>`;
  }
  if(kind==='event'){
    return `
      <div>
        <div style="font-size:20px;font-weight:800">${esc(d.event||'—')}</div>
        ${imgHtml}${audioHtml}
        <div class="hint">Tap for details</div>
      </div>`;
  }
  if(kind==='details'){
    return `
      <div>
        <div style="font-size:16px;font-weight:700;max-width:90%">${esc(d.details||'—')}</div>
        ${imgHtml}${audioHtml}
        <div class="hint">Tap for place</div>
      </div>`;
  }
  // place
  return `
    <div>
      <div style="font-size:18px;font-weight:800">${esc(d.place||'—')}</div>
      ${imgHtml}${audioHtml}
      <div class="hint">Tap to return to date</div>
    </div>`;
}

function renderImage(d){
  const imgs = toArr(d.image || d.images);
  if(!imgs.length) return '';
  const src = String(imgs[0]);
  const more = imgs.length>1 ? `<div class="mediaNote">+${imgs.length-1} more image(s)</div>` : '';
  return `<div class="mediaBox"><img class="mediaImg" loading="lazy" decoding="async" src="${src}" alt="${esc(d.event||d.details||d.place||d.dateStr)}">${more}</div>`;
}
function renderAudio(d){
  const auds = toArr(d.audio || d.audios || d.sound);
  if(!auds.length) return '';
  const sources = auds.map(u=>`<source src="${u}">`).join('');
  return `<div class="audioWrap"><audio controls preload="none">${sources}</audio></div>`;
}

/* ====== NORMALIZATION ====== */
function normalize(item){
  // Accept date in dd-mm-yyyy or dd/mm/yyyy (preferred: dd-mm-yyyy)
  const dateStrRaw =
    item.date ?? item.Date ?? item.date_ddmmyyyy ?? item['dd-mm-yyyy'] ?? null;
  const parsed = parseDDMMYYYY(dateStrRaw);
  // If missing but a year exists, you could fallback: 01-01-year (optional)
  if(!parsed) return { dateTs:null };

  const {ts, y, m, d} = parsed;
  const dateStr = [pad(d), pad(m), y].join('-');

  const event   = item.event ?? item.Event ?? item.title ?? item.Title;
  const details = item.details ?? item.Details ?? item.desc ?? item.Description;
  const place   = item.place ?? item.Place ?? item.location ?? item.Location;
  const image   = item.image ?? item.images ?? item.Image ?? item.Images ?? null;
  const audio   = item.audio ?? item.audios ?? item.Audio ?? item.Audios ?? null;
  return { dateTs:ts, dateStr, year:y, month:m, day:d, event, details, place, image, audio };
}

function parseDDMMYYYY(s){
  if(!s) return null;
  const m = String(s).trim().match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
  if(!m) return null;
  const d = +m[1], mo = +m[2], y = +m[3];
  const dt = new Date(Date.UTC(y, mo-1, d)); // avoid timezone shifts
  if(dt.getUTCFullYear()!==y || dt.getUTCMonth()+1!==mo || dt.getUTCDate()!==d) return null; // invalid (e.g., 31-02-2020)
  return {ts:dt.getTime(), y, m:mo, d};
}

/* ====== UTILS ====== */
const pad = n => (n<10?'0':'')+n;
function toArr(v){ return v==null ? [] : (Array.isArray(v) ? v : [v]); }
const esc = s => String(s==null?'':s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
function el(tag, cls, text){ const e=document.createElement(tag); if(cls) e.className=cls; if(text!=null) e.textContent=text; return e; }
</script>
</body>
</html>
